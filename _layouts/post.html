<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title }} | LifeOnline</title>
  <link rel="stylesheet" href="{{ '/assets/style.css' | relative_url }}">
</head>
<body class="post-layout">

  <header>
    <div class="branding-container">
      <a href="{{ '/' | relative_url }}" class="site-logo">
        <img src="{{ '/assets/images/Logo.png' | relative_url }}" alt="0xR0K Logo">
      </a>
      <div class="site-identity">
        <h1><a href="{{ '/' | relative_url }}">LIFEONLINE</a></h1>
        <p>Toda una vida Conectado</p>
      </div>
    </div>
    <nav>
      <ul>
        <li><a href="{{ '/articulos/' | relative_url }}">Art√≠culos</a></li>
      </ul>
    </nav>
  </header>

  <main class="article-container">
    <header class="article-header">
      <h1 class="article-title">{{ page.title }}</h1>
      <div class="title-separator"></div>
    </header>

    <div class="article-content" id="markdown-content">
      {{ content }}
    </div>
  </main>

  <footer>
    <p>&copy; 2025 LifeOnline | 0xR0K</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      
      const contentDiv = document.getElementById("markdown-content");
      const postSlug = "{{ page.slug }}"; 
      const baseUrl = "{{ site.baseurl }}";

      function createImgTag(fileName, className) {
        const cleanFileName = encodeURIComponent(fileName.trim());
        const finalPath = `${baseUrl}/assets/images/${postSlug}/${cleanFileName}`;
        return `<img src="${finalPath}" alt="${fileName}" class="${className}">`;
      }

      const codeBlocks = contentDiv.querySelectorAll("pre code");
      codeBlocks.forEach(block => {
        const text = block.textContent.trim();
        const match = text.match(/^!\[\[(.*?)\]\]$/);

        if (match) {
          const fileName = match[1];
          const imgHTML = createImgTag(fileName, "obsidian-img-auto");
          const preTag = block.parentElement;
          const imgContainer = document.createElement("div");
          imgContainer.className = "rescued-image-container";
          imgContainer.style.textAlign = "center";
          imgContainer.innerHTML = imgHTML;
          preTag.replaceWith(imgContainer);
        }
      });

      const walker = document.createTreeWalker(contentDiv, NodeFilter.SHOW_TEXT, null, false);
      let node;
      const nodesToReplace = [];

      while(node = walker.nextNode()) {
        if (node.nodeValue.includes("![[")) {
          nodesToReplace.push(node);
        }
      }

      nodesToReplace.forEach(textNode => {
        const parent = textNode.parentNode;
        if (parent.tagName === 'SCRIPT' || parent.tagName === 'STYLE') return;

        const fragment = document.createDocumentFragment();
        const parts = textNode.nodeValue.split(/(!\[\[.*?\]\])/g);

        parts.forEach(part => {
          const match = part.match(/!\[\[(.*?)\]\]/);
          if (match) {
            const span = document.createElement("span");
            span.innerHTML = createImgTag(match[1], "obsidian-img-auto");
            fragment.appendChild(span);
          } else {
            fragment.appendChild(document.createTextNode(part));
          }
        });
        parent.replaceChild(fragment, textNode);
      });

      const blockquotes = document.querySelectorAll("blockquote");
      
      blockquotes.forEach(quote => {
        const firstP = quote.querySelector("p");
        if (!firstP) return;

        const rawText = firstP.textContent.trim();
        const match = rawText.match(/^\[!(\w+)\]/);
        
        if (match) {
          const typeRaw = match[1];
          const type = typeRaw.toLowerCase();
          
          let titleText = rawText.replace(match[0], "").trim();
          
          const tagRegex = new RegExp(`\\[!${typeRaw}\\]`, "i");
          firstP.innerHTML = firstP.innerHTML.replace(tagRegex, "");
          
          if (titleText.length > 0) {
            firstP.innerHTML = firstP.innerHTML.replace(titleText, "");
          } else {
            titleText = type.toUpperCase();
          }

          if (firstP.textContent.trim() === "") {
            firstP.style.display = "none";
          }

          let icon = "üìù";
          if (type.includes('warn') || type.includes('alert')) { icon = "‚ö†Ô∏è"; if(titleText === type.toUpperCase()) titleText = "ALERTA"; }
          else if (type.includes('danger') || type.includes('error')) { icon = "üî•"; if(titleText === type.toUpperCase()) titleText = "PELIGRO"; }
          else if (type.includes('success') || type.includes('check')) { icon = "‚úÖ"; if(titleText === type.toUpperCase()) titleText = "√âXITO"; }
          else if (type.includes('info') || type.includes('note')) { icon = "‚ÑπÔ∏è"; if(titleText === type.toUpperCase()) titleText = "NOTA"; }
          else if (type.includes('tip')) { icon = "üí°"; if(titleText === type.toUpperCase()) titleText = "CONSEJO"; }

          quote.classList.add("callout");
          quote.classList.add(`callout-${type}`);

          const headerDiv = document.createElement("div");
          headerDiv.className = "callout-header";
          headerDiv.innerHTML = `<span class="callout-icon">${icon}</span> <strong class="callout-title-text">${titleText}</strong>`;
          
          const contentWrapper = document.createElement("div");
          contentWrapper.className = "callout-content";

          while (quote.firstChild) {
            contentWrapper.appendChild(quote.firstChild);
          }

          quote.appendChild(headerDiv);
          quote.appendChild(contentWrapper);
        }
      });
    });
  </script>
</body>
</html>
