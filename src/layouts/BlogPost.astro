---
import Layout from './Layout.astro';

const { title, description, date } = Astro.props;

const formattedDate = date ? new Date(date).toLocaleDateString('es-ES', {
	year: 'numeric',
	month: 'long',
	day: 'numeric',
}) : '';
---

<Layout title={title} description={description}>
	<article class="article-container">
		<header class="article-header">
			<h1 class="article-title">{title}</h1>
			{formattedDate && <p class="article-date">{formattedDate}</p>}
			<div class="title-separator"></div>
		</header>

		<div class="article-content" id="markdown-content">
			<slot />
		</div>
	</article>
</Layout>

<script>
	function processContent() {
		const content = document.getElementById('markdown-content');
		if (!content) return;

		const currentSlug = window.location.pathname.replace(/\/$/, '').split('/').pop().toLowerCase();

		const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT, null, false);
		const nodesToReplace = [];
		
		while(walker.nextNode()) {
			if (walker.currentNode.nodeValue && walker.currentNode.nodeValue.includes('![[')) {
				nodesToReplace.push(walker.currentNode);
			}
		}

		nodesToReplace.forEach(node => {
			if (node.parentElement && ['SCRIPT', 'STYLE'].includes(node.parentElement.tagName)) return;

			const fragment = document.createDocumentFragment();
			const parts = node.nodeValue ? node.nodeValue.split(/(!\[\[.*?\]\])/g) : [];

			parts.forEach(part => {
				const match = part.match(/!\[\[(.*?)\]\]/);
				if (match) {
					const fileName = match[1];
					const imgPath = `/images/${currentSlug}/${fileName}`;
					
					const img = document.createElement('img');
					img.src = imgPath;
					img.alt = fileName;
					img.loading = "lazy";
					img.classList.add('obsidian-img');
					
					img.onerror = function() { 
						this.style.display = 'none';
					};

					fragment.appendChild(img);
				} else {
					fragment.appendChild(document.createTextNode(part));
				}
			});

			node.parentNode?.replaceChild(fragment, node);
		});

		const blockquotes = document.querySelectorAll('blockquote');
		
		blockquotes.forEach(quote => {
			const text = quote.textContent?.trim() || '';
			const match = text.match(/^\[!(\w+)\]/);
			
			if (match && !quote.classList.contains('processed-callout')) {
				const typeRaw = match[1];
				const type = typeRaw.toLowerCase();
				let titleText = type.toUpperCase();

				quote.classList.add('processed-callout');

				const iconMap = {
					note: '✎', info: 'ℹ', todo: '☐', tip: '★',
					important: '‼', success: '✓', question: '?',
					warning: '⚠', failure: '✕', danger: '⚡',
					bug: '☢', example: '☞', quote: '❝'
				};

				const icon = iconMap[type] || '✎';
				
				const firstP = quote.querySelector('p');
				if (firstP) {
					const headerRegex = new RegExp(`\\[!${typeRaw}\\]\\s*(.*)`, "i");
					const headerMatch = firstP.textContent?.match(headerRegex);
					
					if (headerMatch && headerMatch[1] && headerMatch[1].trim() !== '') {
						titleText = headerMatch[1].trim();
					}

					firstP.innerHTML = firstP.innerHTML.replace(new RegExp(`\\[!${typeRaw}\\]\\s*.*?(\\n|<br>|$)`, "i"), '');
					if (firstP.textContent.trim() === '') {
						firstP.remove();
					}
				} else {
					quote.innerHTML = quote.innerHTML.replace(new RegExp(`\\[!${typeRaw}\\]\\s*.*?(\\n|<br>|$)`, "i"), '');
				}

				quote.classList.add('callout', `callout-${type}`);

				const header = document.createElement('div');
				header.className = 'callout-header';
				header.innerHTML = `<span class="callout-icon">${icon}</span> <strong>${titleText}</strong>`;
				
				const contentWrapper = document.createElement('div');
				contentWrapper.className = 'callout-content';
				
				while (quote.firstChild) {
					contentWrapper.appendChild(quote.firstChild);
				}

				quote.appendChild(header);
				quote.appendChild(contentWrapper);
			}
		});
	}

	document.addEventListener('DOMContentLoaded', processContent);
	document.addEventListener('astro:page-load', processContent);
	processContent();
</script>

<style>
	.article-date {
		text-align: center;
		color: var(--text-main);
		opacity: 0.6;
		font-family: var(--font-code);
		font-size: 0.9rem;
		margin-top: 10px;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
    
    .obsidian-img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 30px auto;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
</style>
