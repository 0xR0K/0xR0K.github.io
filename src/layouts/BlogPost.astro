---
import Layout from './Layout.astro';

const { title, description, date } = Astro.props;

const formattedDate = date ? new Date(date).toLocaleDateString('es-ES', {
	year: 'numeric',
	month: 'long',
	day: 'numeric',
}) : '';
---

<Layout title={title} description={description}>
	<article class="article-container">
		<header class="article-header">
			<h1 class="article-title">{title}</h1>
			{formattedDate && <p class="article-date">{formattedDate}</p>}
			<div class="title-separator"></div>
		</header>

		<div class="article-content" id="markdown-content">
			<slot />
		</div>
	</article>
</Layout>

<script>
	function processContent() {
		const content = document.getElementById('markdown-content');
		if (!content) return;

		const currentSlug = window.location.pathname.replace(/\/$/, '').split('/').pop();

		const contentHTML = content.innerHTML;
		const newContent = contentHTML.replace(/!\[\[(.*?)\]\]/g, (match, fileName) => {
			const cleanName = fileName.trim();
			const imgPath = `/images/${currentSlug}/${cleanName}`;
			return `<img src="${imgPath}" alt="${cleanName}" loading="lazy" class="obsidian-img" onerror="this.style.display='none'">`;
		});
		
		if (content.innerHTML !== newContent) {
			content.innerHTML = newContent;
		}

		const blockquotes = document.querySelectorAll('blockquote');
		
		blockquotes.forEach(quote => {
			const firstP = quote.querySelector('p');
			const textToCheck = firstP ? firstP.textContent : quote.textContent;
			
			if (!textToCheck) return;

			const match = textToCheck.match(/^\[!(\w+)\]/);
			
			if (match && !quote.classList.contains('processed-callout')) {
				const typeRaw = match[1];
				const type = typeRaw.toLowerCase();
				let titleText = type.toUpperCase();

				quote.classList.add('processed-callout');

				const iconMap = {
					note: '✎', info: 'ℹ', todo: '☐', tip: '★',
					important: '‼', success: '✓', question: '?',
					warning: '⚠', failure: '✕', danger: '⚡',
					bug: '☢', example: '☞', quote: '❝'
				};

				// @ts-ignore
				const icon = iconMap[type] || '✎';
				
				if (firstP) {
					const headerRegex = new RegExp(`\\[!${typeRaw}\\]\\s*(.*)`, "i");
					const headerMatch = firstP.textContent?.match(headerRegex);
					
					if (headerMatch && headerMatch[1] && headerMatch[1].trim() !== '') {
						titleText = headerMatch[1].trim();
					}

					firstP.innerHTML = firstP.innerHTML.replace(new RegExp(`\\[!${typeRaw}\\]\\s*.*?(\\n|<br>|$)`, "i"), '');
					
					if (firstP.textContent.trim() === '') {
						firstP.remove();
					}
				} else {
					quote.innerHTML = quote.innerHTML.replace(new RegExp(`\\[!${typeRaw}\\]\\s*.*?(\\n|<br>|$)`, "i"), '');
				}

				quote.classList.add('callout', `callout-${type}`);

				const header = document.createElement('div');
				header.className = 'callout-header';
				header.innerHTML = `<span class="callout-icon">${icon}</span> <strong>${titleText}</strong>`;
				
				const contentWrapper = document.createElement('div');
				contentWrapper.className = 'callout-content';
				
				while (quote.firstChild) {
					contentWrapper.appendChild(quote.firstChild);
				}

				quote.appendChild(header);
				quote.appendChild(contentWrapper);
			}
		});
	}

	document.addEventListener('DOMContentLoaded', processContent);
	document.addEventListener('astro:page-load', processContent);
	processContent();
</script>

<style is:global>
	.article-date {
		text-align: center;
		color: var(--text-main);
		opacity: 0.6;
		font-family: var(--font-code);
		font-size: 0.9rem;
		margin-top: 10px;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
    
    .obsidian-img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 30px auto;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

	blockquote.callout {
		margin: 2.5em 0;
		padding: 0;
		border: 1px solid var(--border-color);
		border-left-width: 5px;
		background-color: var(--bg-card);
		border-radius: 6px;
		font-style: normal;
		overflow: hidden;
	}

	.callout-header {
		padding: 10px 15px;
		background-color: rgba(255, 255, 255, 0.03);
		font-weight: 700;
		font-size: 0.95em;
		display: flex;
		align-items: center;
		gap: 10px;
		border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		color: var(--text-bright);
	}

	.callout-icon {
		font-family: "Segoe UI Emoji", "Apple Color Emoji", sans-serif;
		font-size: 1.1em;
	}

	.callout-content {
		padding: 15px 20px;
		font-size: 0.95em;
		color: var(--text-main);
	}
	
	.callout-content p:last-child {
		margin-bottom: 0;
	}

	.callout-note, .callout-info { border-left-color: var(--color-blue); }
	.callout-note .callout-header { color: var(--color-blue); background-color: rgba(139, 233, 253, 0.05); }

	.callout-tip, .callout-success { border-left-color: var(--color-green); }
	.callout-tip .callout-header { color: var(--color-green); background-color: rgba(80, 250, 123, 0.05); }

	.callout-warning, .callout-attention { border-left-color: var(--color-orange); }
	.callout-warning .callout-header { color: var(--color-orange); background-color: rgba(255, 184, 108, 0.05); }

	.callout-danger, .callout-error, .callout-bug { border-left-color: var(--color-red); }
	.callout-danger .callout-header { color: var(--color-red); background-color: rgba(255, 85, 85, 0.05); }
</style>
